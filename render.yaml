# InvoiceFlow - Production Deployment Infrastructure (Render Blueprint)
# Format: Infrastructure-as-Code (Blueprint)
# Version: 1.0.0
# Last Updated: 2026-02-01

services:
  # ---------------------------------------------------------------------------
  # Core Web Service: InvoiceFlow API & Frontend
  # ---------------------------------------------------------------------------
  - type: web
    name: invoiceflow-web
    env: python
    buildCommand: ./build.sh
    startCommand: gunicorn invoiceflow.wsgi:application -c gunicorn.conf.py
    plan: starter
    region: oregon
    envVars:
      # Application Environment
      - key: PYTHON_VERSION
        value: "3.12.0"
      - key: PRODUCTION
        value: "true"
      - key: DEBUG
        value: "false"
      - key: DJANGO_SETTINGS_MODULE
        value: "invoiceflow.settings"
      - key: PORT
        value: "5000"
      
      # Security & Secret Management (Generated by Render)
      - key: SECRET_KEY
        generateValue: true
      - key: ENCRYPTION_SALT
        generateValue: true
      
      # Database Connection (Linked to Database Service)
      - key: DATABASE_URL
        fromDatabase:
          name: invoiceflow-db
          property: connectionString
      
      # Networking & SSL
      - key: SITE_URL
        value: "https://invoiceflow.com.ng"
      - key: ALLOWED_HOSTS
        value: "invoiceflow-web.onrender.com,invoiceflow.com.ng,www.invoiceflow.com.ng"
      - key: CSRF_TRUSTED_ORIGINS
        value: "https://invoiceflow-web.onrender.com,https://invoiceflow.com.ng,https://www.invoiceflow.com.ng"
      
      # Resource Optimization (Gunicorn)
      - key: WEB_CONCURRENCY
        value: "4"
      - key: GUNICORN_THREADS
        value: "4"
      - key: GUNICORN_WORKER_CLASS
        value: "gthread"
      - key: GUNICORN_GRACEFUL_TIMEOUT
        value: "30"
      - key: GUNICORN_LOG_LEVEL
        value: "info"
      
      # External Services: Email (SendGrid)
      - key: EMAIL_HOST
        value: "smtp.sendgrid.net"
      - key: EMAIL_HOST_USER
        value: "apikey"
      - key: EMAIL_PORT
        value: "587"
      - key: EMAIL_USE_TLS
        value: "True"
      - key: DEFAULT_FROM_EMAIL
        value: "Invoice Flow <noreply@invoiceflow.com.ng>"
      
      # External Services: Secrets (Must be provided via Render UI)
      - key: SENDGRID_API_KEY
        sync: false
      - key: PAYSTACK_SECRET_KEY
        sync: false
      - key: REDIS_URL
        sync: false

    # Health Checks & Reliability
    healthCheckPath: /health/live/
    autoDeploy: true
    numInstances: 1
    preDeployCommand: python manage.py check --deploy

# ---------------------------------------------------------------------------
# Database Service: Managed PostgreSQL
# ---------------------------------------------------------------------------
databases:
  - name: invoiceflow-db
    plan: starter
    databaseName: invoiceflow
    postgresMajorVersion: 16
    ipAllowList: [] # Standard Render security (internal access only)
